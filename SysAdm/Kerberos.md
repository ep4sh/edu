![Kerberos](../img/kerberos.jpg)

# Kerberos - сетевой протокол аутентификации

1. Юзер указывает **login** и **домен** в котором надо провести аутентификацию.

2. Клиент передает:
 * login --- в открытом виде
 * domain
 * timestamp -- АУТЕНТИФИКАТОР, в закрытом виде, ключ для шифра - пароль юзера.
 * на KDC (домен-контроллер).  

Чтобы обратиться к KDC нужно выполнить разрешение имени этой службы в ip-адрес, поэтому DC жестко привязан к DNS .

3. Служба KDC ищет юзера в AcitveDirectory, выявляет **МАСТЕР-ключ**, основынный на пароле и расшифровывает аутентификатор - получает время отправки запроса (разница в отправке и времени на DC не должна быть большой).

4. KDC создаёт два объекта:  
  - Ключ сессии, посредством коротого будет обеспечено шифрование данных при обмене Client и KDC.
  - (b) Билет на получение билета (**TGT** - вторая копия ключа сессии, имя юзера, время окончании жизни билета.). Шифруется с помощью СОБСТВЕННОГО ключа, известного только KDC.
  - Затем ключом КЛИЕНТА шифрует timestamp + TGT и отправляет юзеру.

5. Клиент получает данные, расшифровывает их и проверяет timestamp. Теперь обладая **TGT** можно получать доступ к ресурсам домена.



**************************************************************

Доступ к серверу.

1. Клиенту нужен доступ к Файловому серверу в Домене.

2. Клиент обращается к KDC , предоставляя TGT+timestamp, зашифрованные ключом сессии (известного KDC)

3.   
 - KDC расшифровывает **TGT** -- собственным ключом (пункт 4b)
 - KDC расшифровывает **timestamp** - сессионным ключом.
 - Теперь **KDC** может подтвердить, что запрос пришел от "правильного" юзера.
 - Потом KDC создает пару билетов: для сервера (к которому нужно получить доступ) и клиента.
 - Билет содержит **login**, **timestamp**, **lifetime**.
 - Оба билета содержат общий ключ - **KCS**, известный и клиенту и серверу - обеспечивает возможность безопасного взаимодействия между ними.
 - KDC шифрует билет сервера используя мастер-ключ сервера, затем вкладывает билет Сервера внутрь билета Клиента, вся структура шифруется сессионным ключом, доступным пользователю.
 - Информация отправляется клиенту.

4.  
 - Получив билет, клиент расшифровывает его с помощью сессионного ключа. Ему становятся доступны: его ключ, общий с сервером ключ. Но клиент не может прочитать билет сервера (зашифрован ключом сервера)
Клиент зашифровывает timestamp с помощью ключа KCS и билет сервера СЕРВЕРУ РЕСУРСОВ.
 - СЕРВЕР РЕСУРСОВ расшифровывает **свой билет** и получает доступ к общему с клиентом ключу.
 - расшифровывается маркер времени, полученный от клиента. Клиент и сервер обладают общим ключом KSC и сервер уверен, что пользователь верный.



