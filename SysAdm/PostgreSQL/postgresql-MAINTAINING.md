![PostgreSQL](../../img/postgresql.png)

## Сопровождение

### Процесс очистки

#### Варианты запуска

```
VACUUM // очистка БД
VACUUM таблица // очистка конкретной таблицы
```
* Выполняется паралленльо с другими транзакциями  
* частый запуск нагружает IO  
* редкий запуск приводит к росту таблиц  

Поэтому полагаются на `autovacuum`:

`autovacuum launcher`
`autovacuum worker`
* Частота обработки таблицы **ДИНАМИЧЕСКИ** меняется в зависимости от частоты изменений
* настраивается конфигурацией.

Если уж таблица сильно выросла, то её можно сжать:  
```
VACUUM FULL // full очистка БД
VACUUM FULL таблица // full очистка конкретной таблицы
```
* Полностью перестраивает содержимое таблиц, индексов
* уменьшает размер файлов и минимизирует место
* требует эксклюзивной блокировки таблицы


#### Обновление статистики  

Фоновый процесс autovacuum
* автоматически обновляет статистику при значительных изменениях
* используется случайная выборка данных (размер настраивается)

Обновление статистики вручную:  
```
ANALYZE [таблица]
```

Помимо очистки обновит статистику:  
```
VACUUM ANALYZE [таблица]
```


#### Обновление карт видимости
* битовая карта со всеми видимыми версиями строк
* видимость сбрасывается при любом изменении
* видимость устанавливается автоматом при очистке

#### Обновление свободного пространства
* структура, отмечающая свободного место в страницах
* обновляется в тч при очистке
* используется для поиска страниц при вставке новых строк

#### Номера транзакций
* Счетчик транзакций закольцованн (32bit)
* Старые версии строк замораживаются автоочисткой




### Мониторинг индексов и их перестроение

#### Лишние индексы
* не используется* дублирующиеся / пересекающиеся
* проблемы: накладные расходы, место на диске
* решение: удаление лишних индексов (аккуратное)

Разрастание индексов
Мониторинг `pg_relation_size()`
проблемы место на диске, уменьшение эффективности
решение перестроение индексов

```
CREATE EXTENSIONS pgstattuple;
```
