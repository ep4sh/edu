![PostgreSQL](../../img/postgresql.png)

# Репликация  
Процесс синхронизации нескольких копий кластера на разных серверах


* `wal_level = replica`
* `max_wal_sender = 10`
* разрешение на подключение `pg_hba.conf`
* `pg_ctl promote` // стать мастером


## Задачи

### Отказоустойчивость:   
При выходе из строя оного из серверов, система сохранит доступность

### Масштабируемость:  
Распределение нагрузки между серверами


## ФИзическая репликация

* СХЕМА мастер-реплика: поток данных только в одну сторону
* трансляция потока журнальных записей или файлов
* требуется двоичная совместимость серверов
* возможна репликация только всего кластера

### Как сделать реплику:

Резервная копия:  
 * базовая Резервная копия - `pg_basebackup`
 * WAL - непрерывное архивирование

Непрерывное восстановление:  
* разворачиваем резервную копию
* создаем управляющий файл `recovery.conf` (`standby_mode = on`) и запускаем сервер
* из-за `standby_mode = on` реплика не выходит из режима восстановления
* сервер восстанавливает согласованность, продолжает применять поступающие журналы 
* доставка - поток про протоколу репликации или архив WAL
* подключения (`READONLY`) разрешаются сразу после восстановления согласованности



* Синхронная репликация(мастер ждёт отчёта о приёме данных репликой)
* Каскадная репликация(матер [реплика ->реплика])
* Отложенная репликация (восстановление на момент времени)






## Логическая репликация
* СХЕМА поставщик-подписчик: поток данных возможен в обе стороны
* информация о строках (уровень журанла `logical`)
* требуется совместимость на уровне *ПРОТОКОЛА*
* возможна выборочная репликация отдельных таблиц


### Поставщик
* выдает изменения данных построчно в порядке их фиксации
* реплицируется ТОЛЬКО INSERT, UPDATE,
* возможна начальная синхронизация
* всегда использует слот логической репликации
* wal_level = logical

### Подписчик
* получает и приминяет изменения
* без рабора, трансформаций, планирования - сразу выполнение
* возможны конфликты с локальными даннымми

```
CREATE PUBLICATION test_pub  FOR TABLE test;

CREATE SUBSCRIPTION test_sub
    CONNECTION 'host=localhost port=5432 user=postgres dbname=replica' 
    PUBLICATION test_pub WITH (copy_data = false);

\dRp+
```
