# Сказ о том как на софтовом raid1 тормозил безбожно рабочий почтовый сервак на 50 пользователей.

fetchmail 300 секунд  
dovecot  
postfix  



Есть софтовый массив:
```
md0 : active raid1 sdb1[1] sda1[0]
      976629760 blocks super 1.2 [2/2] [UU]
      bitmap: 5/8 pages [20KB], 65536KB chunk
```

не было нагрузки на сервак и он работал исправно,
теперь же перенес часть сервисов сюда и диск грузится на 100%+ при записи.
Load_avg просто в облака завышен (проц почти не задействован).

Очень сильно грузит диск процесс **JBD2**.

/etc/fstab:
```
/dev/mapper/mail--vg-vmail on /var/vmail type ext4 (rw,noatime,errors=remount-ro,data=ordered)
```


В близжайшее регламентное облсуживание сменю опции ФС:
```
/dev/mapper/mail--vg-vmail /var/vmail ext4 errors=remount-ro,noatime,data=writeback,commit=60 0 0
```

Что еще можно сделать для ускорения md0? убрать к чертям bitmap ? 


```
root@mail:~# iostat -xdm | grep sd
sda               0,17    13,99    0,81   57,50     0,02     0,48    17,57     0,48    8,31   13,83    8,23   2,52  14,71
sdb               0,06    13,96    0,28   57,53     0,00     0,48    17,00     0,48    8,30   25,00    8,22   2,51  14,53
root@mail:~# iostat -xdm | grep dm
dm-0              0,00     0,00    0,23   19,11     0,01     0,10    11,34     0,45   23,26   12,68   23,39   5,43  10,50
dm-1              0,00     0,00    1,07   48,20     0,02     0,37    16,30     0,62   12,67   16,92   12,58   2,09  10,32
dm-2              0,00     0,00    0,00    0,00     0,00     0,00    10,07     0,00    7,63    1,18   14,73   1,12   0,00
```


`sync; dd if=/dev/zero of=/tempfile bs=1M count=10; sync;`

Сменил опции ext4: 
```
sudo umount /dev/sda1
sudo tune2fs -o journal_data_writeback /dev/sda1
sudo tune2fs -O ^has_journal /dev/sda1
sudo e2fsck -f /dev/sda1
```

JBD перестал гнобить систему, но скорость random-write осталась медленной :(

```
root@mail:/var/vmail# dd if=/dev/zero of=tempfile bs=1M count=1000 oflag=direct
1000+0 записей получено
1000+0 записей отправлено
1048576000 байт (1,0 GB, 1000 MiB) скопирован, 75,6963 s, 13,9 MB/s
root@mail:/var/vmail# dd if=/dev/zero of=tempfile bs=1M count=1000 oflag=direct
1000+0 записей получено
1000+0 записей отправлено
1048576000 байт (1,0 GB, 1000 MiB) скопирован, 59,2284 s, 17,7 MB/s
```


>>У тебя терабайтные диски, у них максимальная скорость линейной записи должна быть порядка 90-100 мб/сек. Почтовик тебе генерит довольно много random write-ов, а там производительность в лучшем случае будет 20-30Мб/сек.



>>Можешь попробовать поиграться с io-шедулерами. Поставить blk-mq, например, если у тебя ядро 4.14+
>>Сильного прироста это не даст, но возможно станет полегче: https://blog.codeship.com/linux-io-scheduler-tuning/


>>Еще можно запустить почтовик в отдельной blkio-сигруппе и зарезать его по io. Он станет медленнее писать на диск, но зато соседям станет легче жить
>>гуглить по blkio + cgroup + throttle

